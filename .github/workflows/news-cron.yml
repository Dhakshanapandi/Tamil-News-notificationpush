name: Run News Feeder (every 30 minutes)

on:
  schedule:
    # runs roughly every 30 minutes. Using 5,35 avoids the "start of hour" heavy load.
    - cron: '5,35 * * * *'
  workflow_dispatch:   # allows manual runs from the Actions UI

jobs:
  run-news:
    runs-on: ubuntu-latest
    concurrency:
      group: newsfeeder
      cancel-in-progress: true
    timeout-minutes: 25   # safety: cancel if it runs >25 minutes

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Restore Firebase service account (base64 secret)
        # if you saved FIREBASE_SERVICE_ACCOUNT_B64 as base64; otherwise skip this step
        run: |
          echo "${{ secrets.FIREBASE_SERVICE_ACCOUNT_B64 }}" | base64 --decode > ./serviceAccount.json

      - name: Run script
        env:
          # Options:
          # 1) If your code reads JSON from env: keep FIREBASE_SERVICE_ACCOUNT as a secret and pass it here
          FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          # 2) If your code reads a file, you wrote it above to ./serviceAccount.json
          YT_API_KEY: ${{ secrets.YT_API_KEY }}
        run: |
          # optional: show brief info to logs (secrets are masked automatically)
          echo "Starting news-feeder at $(date -u)"
          node index.js
